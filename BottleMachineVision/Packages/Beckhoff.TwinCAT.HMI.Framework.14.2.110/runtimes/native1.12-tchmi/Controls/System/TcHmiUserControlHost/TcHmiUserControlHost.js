"use strict";var TcHmi;!function(TcHmi){!function(Controls){!function(System){class TcHmiUserControlHost extends System.TcHmiControl{static#tchmiFQN="TcHmi.Controls.System."+this.name;constructor(element,pcElement,attrs){super(element,pcElement,attrs);let targetUserControl=this.__attrs["data-tchmi-target-user-control"];if(!targetUserControl)throw new Error("Required attribute=data-tchmi-target-user-control is missing.");if(this.__targetUserControlUrl=targetUserControl.value,!this.__targetUserControlUrl)throw new Error("Required attribute=data-tchmi-target-user-control has invalid value.");if(this.__targetUserControlUrlClean=tchmi_path(this.__targetUserControlUrl),!this.__targetUserControlUrlClean)throw new Error("Required attribute=data-tchmi-target-user-control has invalid value.");this.__targetUserControlConfigUrl=this.__targetUserControlUrl.replace(".usercontrol",".usercontrol.json"),this.__targetUserControlConfigUrlClean=tchmi_path(this.__targetUserControlConfigUrl),TCHMI_ENGINEERING&&(this.__onUserControlChangedEventDestroyEvent=TcHmi.EventProvider.register("System.onUserControlChanged",this.__onUserControlChanged()),this.__onUserControlConfigChangedEventDestroyEvent=TcHmi.EventProvider.register("System.onUserControlConfigChanged",this.__onUserControlConfigChanged()),this.__onUserControlCreatedEventDestroyEvent=TcHmi.EventProvider.register("System.onUserControlCreated",this.__onUserControlCreated()),this.__onUserControlRemovedEventDestroyEvent=TcHmi.EventProvider.register("System.onUserControlRemoved",this.__onUserControlRemoved()))}__markup;__config;__targetUserControlUrl;__targetUserControlUrlClean;__targetUserControlConfigUrl;__targetUserControlConfigUrlClean;__targetUserControlControlObject=null;__params=new Map;__partialDefaultVirtualRights=new Map;__onUserControlChangedEventDestroyEvent=null;__onUserControlConfigChangedEventDestroyEvent=null;__onUserControlCreatedEventDestroyEvent=null;__onUserControlRemovedEventDestroyEvent=null;__elementTemplateRoot;__previnit(){if(this.__elementTemplateRoot=this.__element.find(".TcHmi_Controls_System_TcHmiUserControlHost-template"),0===this.__elementTemplateRoot.length&&(this.__elementTemplateRoot=this.__element.find(".tchmi-user-control-host-template")),0===this.__elementTemplateRoot.length)throw new Error("Invalid Template.html");this.__processTargetUserControl(),super.__previnit()}__init(){super.__init()}__attach(){super.__attach()}__detach(){super.__detach()}destroy(){if(!this.__keepAlive){if(this.__elementTemplateRoot&&this.__elementTemplateRoot.empty(),this.__targetUserControlControlObject)try{this.__targetUserControlControlObject.destroy(),this.__targetUserControlControlObject=null}catch(e){TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+"] An uncaught exception occurred while destroying existing TargetUserControl instance:\n",e)}TCHMI_ENGINEERING&&(null!==this.__onUserControlChangedEventDestroyEvent&&(this.__onUserControlChangedEventDestroyEvent(),this.__onUserControlChangedEventDestroyEvent=null),null!==this.__onUserControlConfigChangedEventDestroyEvent&&(this.__onUserControlConfigChangedEventDestroyEvent(),this.__onUserControlConfigChangedEventDestroyEvent=null),null!==this.__onUserControlCreatedEventDestroyEvent&&(this.__onUserControlCreatedEventDestroyEvent(),this.__onUserControlCreatedEventDestroyEvent=null),null!==this.__onUserControlRemovedEventDestroyEvent&&(this.__onUserControlRemovedEventDestroyEvent(),this.__onUserControlRemovedEventDestroyEvent=null)),this.__params=new Map,this.__partialDefaultVirtualRights=new Map,super.destroy()}}static resolveIdScopedMarkup(hostId,ucUrl,markup){let tempDiv=document.createElement("div");tempDiv.innerHTML=markup;let rawUserControlPartial=tempDiv.firstElementChild;if(!rawUserControlPartial)return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.System.TcHmiUserControlHost"}};if("TcHmi.Controls.System.TcHmiUserControl"!==rawUserControlPartial.getAttribute("data-tchmi-type"))return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.System.TcHmiUserControlHost",reason:"Wrong type (not TcHmi.Controls.System.TcHmiUserControl)."}};if(!rawUserControlPartial.id)return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.System.TcHmiUserControlHost",reason:'Root element of file="'+ucUrl+'" is missing required attribute="id".'}};let rawUserControlPartialChildControls=rawUserControlPartial.querySelectorAll("div[data-tchmi-type]"),ucIdArr=[];ucIdArr.push(rawUserControlPartial.id);for(let i=0,ii=rawUserControlPartialChildControls.length;i<ii;i++){let id=rawUserControlPartialChildControls[i].id;ucIdArr.includes(id)||ucIdArr.push(id)}ucIdArr.sort(((a,b)=>a&&a.includes&&a.includes(b)?1:b&&b.includes&&b.includes(a)?-1:0));const symbolExpressionParser=new TcHmi.System.SymbolExpressionFromText(markup);let exprsPP=symbolExpressionParser.resolveExpressionsBySymbolType(TcHmi.SymbolType.PartialParam);if(exprsPP)for(let i=0,ii=exprsPP.length;i<ii;i++){let expr=exprsPP[i];const content=expr.getContent();content&&(markup=markup.replace(new RegExp(tchmi_escape_regex(expr.toString()),"g"),`%pp%${hostId}::${content}%/pp%`))}let exprsCTRL=symbolExpressionParser.resolveExpressionsBySymbolType(TcHmi.SymbolType.Control);if(null!=exprsCTRL)for(let i=0,ii=exprsCTRL.length;i<ii;i++){let expr=exprsCTRL[i];const exprName=expr.getName(),content=expr.getContent();exprName&&ucIdArr.includes(exprName)&&content&&(markup=markup.replace(new RegExp(tchmi_escape_regex(expr.toString()),"g"),`%ctrl%${hostId}.${content}%/ctrl%`))}let regexpString="",replaces={};for(let i=0,ii=ucIdArr.length;i<ii;i++){let ucId=ucIdArr[i];ucId&&(replaces[`"${ucId}"`]=`"${hostId}.${ucId}"`,replaces[`"${ucId}.`]=`"${hostId}.${ucId}.`,replaces[`'${ucId}'`]=`'${hostId}.${ucId}'`,replaces[`'${ucId}.`]=`'${hostId}.${ucId}.`,regexpString.length>0&&(regexpString+="|"),regexpString+=`"${tchmi_escape_regex(ucId)}"|"${tchmi_escape_regex(ucId)}\\.|'${tchmi_escape_regex(ucId)}'|'${tchmi_escape_regex(ucId)}\\.`)}let regexp=new RegExp(regexpString,"g");return markup=markup.replace(regexp,((substring,...args)=>replaces.hasOwnProperty(substring)?replaces[substring]:substring)),{error:TcHmi.Errors.NONE,markup:markup}}__setKeepAlive(value){super.__setKeepAlive(value),this.__targetUserControlControlObject&&this.__targetUserControlControlObject.__setKeepAlive(value)}__processTargetUserControl(){if(this.__elementTemplateRoot&&this.__elementTemplateRoot.empty(),this.__targetUserControlControlObject)try{this.__targetUserControlControlObject.destroy(),this.__targetUserControlControlObject=null}catch(e){TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Attribute=TargetUserControl] An uncaught exception occurred while destroying existing TargetUserControl instance:\n",e)}let paramsOld=this.__params;this.__params.forEach((param=>{if(!param)return;if(!param.descr)return;const descr=param.descr;descr.propertyGetterName&&descr.propertyGetterName in this&&delete this[descr.propertyGetterName],descr.propertySetterName&&this[descr.propertySetterName]&&delete this[descr.propertySetterName]})),this.__params=new Map,this.__partialDefaultVirtualRights=new Map,this.__config=TcHmi.System.Data.Caches.partialCompositeConfigCache.get(this.__targetUserControlConfigUrlClean);let markup,cacheEntry=TcHmi.System.Data.Caches.partialMarkupCache.get(this.__targetUserControlUrlClean);if(this.__markup=cacheEntry?cacheEntry.markup:void 0,!this.__targetUserControlUrl)return;if(!this.__targetUserControlUrlClean)return;if(!this.__targetUserControlConfigUrl)return;if(!this.__targetUserControlConfigUrlClean)return;if(!this.__markup)return void TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Attribute=TargetUserControl] Required TargetUserControl file="+this.__targetUserControlUrlClean+"Â is missing.");if(!this.__config)return void TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Attribute=TargetUserControl] Required TargetUserControl configuration file="+this.__targetUserControlConfigUrlClean+" is missing.");if(!this.__isRecursionSave(this.__targetUserControlConfigUrlClean))return void TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Attribute=TargetUserControl] Loading file="+this.__targetUserControlUrl+" was blocked to avoid recursion!");let result=TcHmiUserControlHost.resolveIdScopedMarkup(this.getId(),this.__targetUserControlUrl,this.__markup);if(result.error!==TcHmi.Errors.NONE)return void(result.details&&result.details.reason&&TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Attribute=TargetUserControl] "+result.details.reason));if(markup=result.markup,!markup)return;let tempDiv=document.createElement("div");tempDiv.innerHTML=markup;let rawUserControlPartial=tempDiv.firstElementChild;if(!rawUserControlPartial)return;if(!rawUserControlPartial.hasAttribute("data-tchmi-type"))return void TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Attribute=TargetContent] Loading UserControl failed, because its first html element is no tchmi control (missing data-tchmi-type attribute).");rawUserControlPartial.setAttribute("data-tchmi-partial-url",tchmi_path(this.__targetUserControlUrl));const config=this.__config;if(config.parameters)for(const parameter of config.parameters)this.__registerUserControlParamAttribute(parameter,paramsOld.get(parameter.name));if(config.virtualRights)for(let i=0,ii=config.virtualRights.length;i<ii;i++)this.__registerVirtualRight(config.virtualRights[i]);const compileResult=TcHmi.System.Services.controlManager.compile(rawUserControlPartial,this);compileResult.error===TcHmi.Errors.NONE&&compileResult.control?(this.__targetUserControlControlObject=compileResult.control,this.__keepAlive&&this.__targetUserControlControlObject.__setKeepAlive(!0),"Content"===this.getWidthMode()&&this.__processWidth(),"Content"===this.getHeightMode()&&this.__processHeight(),this.__elementTemplateRoot[0].appendChild(this.__targetUserControlControlObject.getElement()[0]),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"CurrentUserControl"})):this.__targetUserControlControlObject=null}getCurrentUserControl(){return this.__targetUserControlControlObject}__registerUserControlParamAttribute(descr,paramOld){let attrName=descr.name,pp={descr:null,value:null};this.__params.set(attrName,pp);let schema=TcHmi.Type.getSchema(descr.type);schema||TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Parameter="+attrName+"] Attribute uses invalid data type: "+descr.type);let ppOld=paramOld||null,set=(valueNew,dirtyPaths)=>{if(!tchmi_equal(pp.value,valueNew)){null===dirtyPaths&&(dirtyPaths=void 0);let dirtyPathsNew=null;dirtyPaths&&dirtyPaths.length>0?dirtyPathsNew=Array.from(dirtyPaths):pp.value&&valueNew&&"object"==typeof pp.value&&"object"==typeof valueNew&&(dirtyPathsNew=tchmi_compare_object(pp.value,valueNew)),pp.value=valueNew,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",dirtyPathsNew&&dirtyPathsNew.length>0?{propertyName:descr.propertyName,dirtyPaths:dirtyPathsNew}:{propertyName:descr.propertyName})}},fnSetter=(valueNew,dirtyPaths)=>{if(pp.descr)if(!0===pp.descr.allowSymbolExpressionsInObject){let resolverInfo=this.__objectResolvers.get(pp.descr.propertyName);resolverInfo&&(resolverInfo.watchDestroyer&&resolverInfo.watchDestroyer(),resolverInfo.resolver.destroy());let resolver=new TcHmi.Symbol.ObjectResolver(valueNew,this),onResolverCallback=(dirtyPaths=>data=>{set(data.value,dirtyPaths)})(dirtyPaths);this.__objectResolvers.set(pp.descr.propertyName,{resolver:resolver,watchCallback:onResolverCallback,watchDestroyer:resolver.watch(onResolverCallback)})}else set(valueNew,dirtyPaths)},fnGetter=()=>pp.value,attrValue=null;if(void 0!==this.__attrs&&null!==this.__attrs){let attr=this.__attrs[descr.name];attr&&(attrValue=TcHmi.ValueConverter.toSchemaType(attr.value,schema),null===attrValue&&(attrValue=attr.value))}if(pp.descr=descr,void 0!==descr.defaultValueInternal?pp.value=tchmi_clone_object(descr.defaultValueInternal):schema&&(pp.value=TcHmi.Type.Schema.resolveDefault(schema)),descr.propertySetterName){if(this[descr.propertySetterName])return TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Parameter="+attrName+'] Name of setter: "'+descr.propertySetterName+'" is already in use. Parameter will not be available for further use.'),void this.__params.delete(attrName);this[descr.propertySetterName]=fnSetter}else;if(this[descr.propertyGetterName])return TcHmi.Log.errorEx("[Source=Control, Module="+this.__type+(TcHmiUserControlHost.#tchmiFQN!==this.__type?", Origin="+TcHmiUserControlHost.#tchmiFQN:"")+", Id="+this.getId()+", Parameter="+attrName+'] Name of getter: "'+descr.propertyGetterName+'" is already in use. Parameter will not be available for further use.'),descr.propertySetterName&&delete this[descr.propertySetterName],void this.__params.delete(attrName);this[descr.propertyGetterName]=fnGetter;const isSymbolExpression=TcHmi.Symbol.isSymbolExpression(attrValue);if(ppOld)isSymbolExpression&&ppOld.descr?.type!==pp.descr.type&&TcHmi.Binding.createEx2(attrValue,pp.descr.propertyName,this),fnSetter(ppOld.value);else if(null!=attrValue){let isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(attrValue);isSymbolExpression?isSymbolExpressionEscaped&&fnSetter(TcHmi.Symbol.escapeSymbolExpression(attrValue)):fnSetter(attrValue)}}__registerVirtualRight(virtualRight){"boolean"==typeof virtualRight.defaultValueInternal&&this.__partialDefaultVirtualRights.set(virtualRight.name,virtualRight)}__isRecursionSave(path){let tempParent=this.__parent;for(;null!==tempParent;){if(tempParent.getType()===TcHmiUserControlHost.#tchmiFQN&&void 0!==tempParent.getTargetUserControl&&tchmi_path(tempParent.getTargetUserControl())===path)return!1;tempParent=tempParent.getParent()}return!0}__refreshTargetPartial(){this.__isDestroyed||(this.__targetUserControlControlObject?.__setKeepAlive(!1),this.__processTargetUserControl())}__onUserControlChanged(){return(evt,data)=>{data.url&&data.url===this.__targetUserControlUrlClean&&data.content&&this.__markup&&data.content!==this.__markup&&this.__refreshTargetPartial()}}__onUserControlConfigChanged(){return(evt,data)=>{data.url&&data.url===this.__targetUserControlConfigUrlClean&&this.__refreshTargetPartial()}}__onUserControlCreated(){return(evt,data)=>{data.url&&data.url===this.__targetUserControlUrlClean&&this.__refreshTargetPartial()}}__onUserControlRemoved(){return(evt,data)=>{data.url&&data.url===this.__targetUserControlUrlClean&&this.__refreshTargetPartial()}}getTargetUserControl(){return this.__targetUserControlUrl}setWidthMode(valueNew){let convertedValue=TcHmi.ValueConverter.toSizeModeWithContent(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("WidthMode")),convertedValue!==this.__widthMode&&(this.__widthMode=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"WidthMode"}),this.__processWidthMode())}__processWidth(callerControl){if("Content"===this.getWidthMode()){let newWidthStr="";if(null!==this.__targetUserControlControlObject){const contentPixelSize=this.__targetUserControlControlObject.__getContentWidth();null!==contentPixelSize&&(newWidthStr=contentPixelSize+"px"),callerControl&&this.__targetUserControlControlObject===callerControl||"Content"!==this.__targetUserControlControlObject.getWidthMode()||this.__targetUserControlControlObject.__processWidth(this)}TcHmi.StyleProvider.setSimpleElementStyle(this.__element,"width",newWidthStr)}super.__processWidth(callerControl)}setHeightMode(valueNew){let convertedValue=TcHmi.ValueConverter.toSizeModeWithContent(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("HeightMode")),convertedValue!==this.__heightMode&&(this.__heightMode=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"HeightMode"}),this.__processHeightMode())}__processHeight(callerControl){if("Content"===this.getHeightMode()&&(this.__intHeight=null,null!==this.__targetUserControlControlObject)){const contentPixelSize=this.__targetUserControlControlObject.__getContentHeight();null!==contentPixelSize&&(this.__intHeight=contentPixelSize+"px"),callerControl&&this.__targetUserControlControlObject===callerControl||"Content"!==this.__targetUserControlControlObject.getHeightMode()||this.__targetUserControlControlObject.__processHeight(this)}super.__processHeight(callerControl)}__getContentWidth(){return"Collapsed"===this.__visibility?null:"Content"!==this.getWidthMode()?super.__getContentWidth():null!==this.__targetUserControlControlObject?this.__targetUserControlControlObject.__getContentWidth():null}__getContentHeight(){return"Collapsed"===this.__visibility?null:"Content"!==this.getHeightMode()?super.__getContentHeight():null!==this.__targetUserControlControlObject?this.__targetUserControlControlObject.__getContentHeight():null}getDescriptionAccessByName(name){let access=this.__partialDefaultVirtualRights.get(name);return access||null}}System.TcHmiUserControlHost=TcHmiUserControlHost}(Controls.System||(Controls.System={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),TcHmi.Controls.registerEx("TcHmiUserControlHost","TcHmi.Controls.System",TcHmi.Controls.System.TcHmiUserControlHost);